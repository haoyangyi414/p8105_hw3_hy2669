---
title: "p8105_hw3_hy2669"
author: "haoyang,yi"
date: "2020/10/9"
output: github_document
---

```{r setup, include=FALSE}
library(p8105.datasets)
library(tidyverse)
library(patchwork)
library(rnoaa)
knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp=0.7,
  fig.height = 8,
  out.width = '90%'
)
theme_set(theme_minimal())
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1
```{r}
data("instacart")
```

The dataset contains `r nrow(instacart)` rows and `r ncol(instacart)` columns. Observations are level of items in orders by user, information of items.
```{r}
instacart %>% 
  count(aisle) %>% 
  arrange(desc(n))
```

```{r}
instacart %>% 
  count(aisle) %>% 
  filter(n>10000) %>%
  mutate(aisle = factor(aisle),
         aisle = fct_reorder(aisle,n)) %>% 
  ggplot(aes(x = aisle,y = n)) +
  geom_point()+
  theme(axis.text.x = element_text(angle=90,vjust=0.5,hjust=1))
```

```{r}
instacart %>%
  filter(aisle %in% c("baking ingredients","dog food care","packaged vegetables fruits")) %>%
  group_by(aisle) %>%
  count(product_name) %>%
  mutate(rank = min_rank(desc(n))) %>%
  filter(rank < 4) %>%
  arrange(aisle,rank) %>%
  knitr::kable()
```

```{r}
instacart %>%
  filter(product_name %in% c("Pink Lady Apples","Coffee Ice Cream")) %>%
  group_by(product_name, order_dow) %>%
  summarize(mean_hour = mean(order_hour_of_day)) %>%
  pivot_wider(names_from = order_dow,
              values_from = mean_hour)
```

## Problem 2
```{r tidy the dataset,warning=F}
accel_df=read_csv('./data/accel_data.csv') %>% 
  janitor::clean_names() %>% 
  pivot_longer(
    cols = starts_with("activity"),
    names_to = 'minute',
    values_to = "activity",
    names_prefix = "activity_") %>% # represent the count of activity 1-1440 variables of each minute in column
  mutate(weekday_vs_weekend = day %in% c("Sunday","Saturday"),
           weekday_vs_weekend = case_when(weekday_vs_weekend ~ "weekend",
                                          !weekday_vs_weekend ~ "weekday")) %>% # create new variable weekday_vs_weekend
  mutate(weekday_vs_weekend = as.factor(weekday_vs_weekend),
         minute = as.numeric(minute),
         week = as.factor(week),
         week = forcats::fct_relevel(week),
         day = as.factor(day),
         day = forcats::fct_relevel(day,c("Monday","Tuesday","Wednesday","Thursday",
          "Friday", "Saturday","Sunday"))) %>%  # convert variable classes to be reasonable.
  group_by(week) %>%
  arrange(day,.by_group = TRUE)  # rearrange day variable so that is starts from Monday to Sunday.
  head(accel_df)
  tail(accel_df)
```
  The resulting dataset has 6 variables which are week(1 to 5), day_id (1 to 35), day(Monday,Tuesday..Sunday), minute in each day(1 to 1440), activity and weekday_vs_weekend. There are `r nrow(accel_df)` observations of these variables. Week,day,weekday_vs_weekend are factor variables, day_id, minute, activity are numeric factors.

```{r total activity}
accel_df %>% 
  group_by(week,day) %>% 
  summarize(total_activity_day = sum(activity)) %>% 
  mutate(total_activity_day = round(total_activity_day)) %>%
  pivot_wider(names_from = week,
              names_prefix = "week_",
              values_from = total_activity_day) %>% 
  knitr::kable()
```
  The table containing total daily activities on each day of weeks are created. The table shows that total daily activities on Saturday and Sunday decrease rapidly in week 4, other days in week 4 also show decrease in total activities. Among 7 days of a week, Monday,Friday,Saturday and Sunday have apparent trends from week 1 to 5, Tuesday and Wednesday have relatively steady trends.

```{r make the plot}
accel_df %>%
  group_by(day_id) %>% 
  mutate(minute_day = 1,
         hour_oneday = cumsum(minute_day)%/%60) %>%
  select(-minute_day) %>%
  group_by(day_id,hour_oneday) %>%
  mutate(activity_hour = sum(activity)) %>% 
  ggplot(aes(x = hour_oneday,y = activity_hour, colour = day, group = day_id))+
  stat_smooth(alpha = 0.5, se = F,geom = 'line',method = 'gam')+
  scale_x_continuous(name = 'hour', limits = c(0,24),breaks = seq(0,24,3))+
  scale_y_continuous(name = 'Activity',trans = 'sqrt',limits = c(0,60000),
                     breaks = c(0,2000,10000,40000))+
  labs(title = 'Smooth line of 24-hour activity for 35 days')+
  theme(legend.position = 'bottom')+
  viridis::scale_color_viridis(discrete = T, name = '')+
  guides(color = guide_legend(nrow =1))
```
  In this graph, most of smoothed lines overlap at 0-6 am and 9-12 pm which indicates that the total hourly activity in this period may follow a daily routine: increase in 0-6 am and decrease in 9-12 pm. Hourly activity reach the peak in daytime, around 8-9 am and 4-7 pm. In 1-3 pm there is a fluctuation, most of lines decrease and recover after 3 pm. Sunday, Monday and Friday have relatively higher and steady peaks.
  